<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Animazione Interattiva</title>
<style>
img, video {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover;
    z-index: 1;
    transition: filter 0.1s ease;
}

/* Pulsanti */
.vignette-btn {
    position: absolute;
    padding: 15px 25px;
    font-size: 20px;
    font-family: monospace, sans-serif;
    color: #fff;
    background-color: rgba(0,0,0,0.6);
    border: 3px solid #fff;
    border-radius: 25px;
    cursor: pointer;
    z-index: 10;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    transition: transform 0.2s, background-color 0.2s;
}
.vignette-btn:hover { background-color: rgba(0,0,0,0.8); }

#startBtn { top: 20%; left: 50%; transform: translate(-50%, -50%); }
#openBtn { top: 50%; left: 50%; transform: translate(-50%, -50%); display:none; }

#finalMessage {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 38px;
    font-family: monospace;
    color: black;
    z-index: 11;
    display: none;
    background: transparent;
    white-space: pre-line;
}

#messageInputContainer {
    display: none;
    position: absolute;
    top: 55%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 12;
    text-align: center;
}
#userMessage { width: 260px; font-size: 22px; padding: 6px; }

#messageButtons {
    margin-top: 10px;
}
#messageButtons button {
    font-size: 20px;
    padding: 6px 12px;
    margin: 0 5px;
    cursor: pointer;
}
/* Mobile */
@media screen and (max-width:1000px){
    .vignette-btn { font-size:50px; padding:12px 18px; }
    #startBtn { top: 15%; left: 50%; transform: translate(-50%, -50%); }
    #openBtn { top: 52%; left: 50%; transform: translate(-50%, -50%); }

    /* Final message ottimizzato per mobile */
    #finalMessage { 
        font-size: 4vw;      /* font proporzionale alla larghezza dello schermo */
        padding: 20px;        /* padding ridotto */
        top: 45%; 
        left: 50%; 
        transform: translate(-50%, -50%); 
        white-space: normal; 
        max-width: 90%; 
        word-wrap: break-word; 
        text-align:center;
    }

    #userMessage { width: 400px; font-size: 55px;  padding: 15px;}
    #messageButtons button { font-size: 30px; padding: 20px 25px; }

    #messageInputContainer {
        top: 68%;
        width: 80%;
    }
}

</style>
</head>
<body>

<img id="letterbox" src="letterboxbasic.png">
<video id="video" src="animazione.mp4" style="display:none;"></video>
<img id="openImage" src="open.png" style="display:none;">

<button id="startBtn" class="vignette-btn"></button>
<button id="openBtn" class="vignette-btn"></button>

<div id="finalMessage"></div>

<div id="messageInputContainer">
    <input type="text" id="userMessage" placeholder="message..." maxlength="200">
    <div id="messageButtons">
        <button id="sendMessage">Send</button>
        <button id="noThanks">No Thanks</button>
    </div>
</div>

<audio id="openLetterBoxAudio" src="openletterbox.wav"></audio>
<audio id="fairyAudio" src="fairy.wav"></audio>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
/* --------------------- FIREBASE ---------------------- */
const firebaseConfig = {
  apiKey: "...",
  authDomain: "letterbox-88cb5.firebaseapp.com",
  databaseURL: "https://letterbox-88cb5-default-rtdb.firebaseio.com/",
  projectId: "letterbox-88cb5",
  storageBucket: "letterbox-88cb5.firebasestorage.app",
  messagingSenderId: "...",
  appId: "...",
  measurementId: "..."
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* --------------------- ELEMENTI ---------------------- */
const startBtn = document.getElementById('startBtn');
const openBtn = document.getElementById('openBtn');
const video = document.getElementById('video');
const letterbox = document.getElementById('letterbox');
const openImage = document.getElementById('openImage');
const finalMessage = document.getElementById('finalMessage');
const messageInputContainer = document.getElementById('messageInputContainer');
const userMessageInput = document.getElementById('userMessage');
const sendMessage = document.getElementById('sendMessage');
const noThanks = document.getElementById('noThanks');

const openLetterBoxAudio = document.getElementById('openLetterBoxAudio');
const fairyAudio = document.getElementById('fairyAudio');

/* --------------------- LOGICA ---------------------- */
function typeWriter(el, text, speed=50){
    el.textContent = "";
    let i=0;
    const t=setInterval(()=>{
        el.textContent+=text[i];
        i++;
        if(i>=text.length) clearInterval(t);
    }, speed);
}

let globalMessage = "Write me something…";

// Sincronizza l’ultimo messaggio con Firebase in tempo reale
db.ref("messages").limitToLast(1).on("value", snapshot=>{
    snapshot.forEach(msgSnap=>{
        globalMessage = msgSnap.val().text;
    });
});

// Funzione per mostrare bottone start
function showStartBtn(){
    typeWriter(startBtn, "Any letters for me?");
    startBtn.style.display = "block";
}

// --- START ---
showStartBtn();

startBtn.addEventListener("click", ()=>{
    openLetterBoxAudio.play();
    startBtn.style.display="none";
    letterbox.style.display="none";
    video.style.display="block";
    video.load();
    video.play().catch(()=>{});
});

// --- VIDEO FINITO ---
video.addEventListener("ended", ()=>{
    typeWriter(openBtn, "Open?");
    openBtn.style.display="block";
});

// --- OPEN ---
openBtn.addEventListener("click", ()=>{
    fairyAudio.play();
    openBtn.style.display="none";
    video.style.display="none";

    openImage.style.display="block";
    openImage.style.filter="blur(0px)";
    let blur=0;
    let b=setInterval(()=>{
        blur+=0.3;
        openImage.style.filter=`blur(${blur}px)`;
        if(blur>=4) clearInterval(b);
    },30);

    finalMessage.style.display="block";
    finalMessage.textContent = globalMessage;
    messageInputContainer.style.display="block";
    userMessageInput.value = globalMessage;
});

// --- SEND ---
sendMessage.addEventListener("click", ()=>{
    const txt = userMessageInput.value.trim();
    if(!txt) return;

    // Salva su Firebase
    db.ref("messages").push({
        text: txt,
        timestamp: Date.now()
    });

    // Aggiorna globalMessage e resetta animazione
    globalMessage = txt;
    resetAnimation();
});

// --- NO THANKS ---
noThanks.addEventListener("click", resetAnimation);

// --- RESET ---
function resetAnimation(){
    letterbox.style.display="block";
    video.style.display="none";
    openImage.style.display="none";
    finalMessage.style.display="none";
    openBtn.style.display="none";
    messageInputContainer.style.display="none";
    userMessageInput.value="";

    showStartBtn();
}
</script>
</body>
</html>
